# Руководство по тестированию Task Tracker API

## Обзор

Реализованы тесты для всех основных компонентов системы управления задачами:
- Модели (Task, TaskRole, TaskItem)
- Permissions (доступ к задачам)
- API endpoints (CRUD операции, фильтрация, персональные представления)

## Структура тестов

```
apps/tasks/tests/
├── __init__.py
├── conftest.py           # Фикстуры для тестов
├── test_models.py        # Тесты моделей
├── test_permissions.py   # Тесты прав доступа
└── test_views.py         # Тесты API endpoints
```

## Запуск тестов

### С использованием Docker Compose

```bash
# Запустить все тесты
docker-compose exec web pytest

# Запустить тесты с покрытием
docker-compose exec web pytest --cov=apps.tasks --cov-report=html

# Запустить конкретный файл тестов
docker-compose exec web pytest apps/tasks/tests/test_models.py

# Запустить конкретный тест
docker-compose exec web pytest apps/tasks/tests/test_models.py::TestTaskModel::test_task_creation

# Запустить тесты с выводом print
docker-compose exec web pytest -s

# Запустить тесты с подробным выводом
docker-compose exec web pytest -v
```

### Локально (без Docker)

```bash
# Активировать виртуальное окружение
source venv/bin/activate

# Установить зависимости для тестирования
pip install -r requirements/development.txt

# Запустить тесты
pytest

# С покрытием
pytest --cov=apps.tasks --cov-report=html
```

## Покрытие тестами

### Модели (test_models.py)

**TestTaskModel:**
- ✅ Создание задачи
- ✅ Строковое представление
- ✅ Расчет прогресса без подзадач
- ✅ Расчет прогресса с подзадачами
- ✅ Расчет общей плановой трудоемкости
- ✅ Получение постановщика
- ✅ Получение всех участников
- ✅ Работа с source_links

**TestTaskRoleModel:**
- ✅ Создание роли
- ✅ Строковое представление
- ✅ Валидация: только один постановщик на задачу
- ✅ Множественные соисполнители
- ✅ Множественные наблюдатели
- ✅ Уникальность (task, user, role)

**TestTaskItemModel:**
- ✅ Создание подзадачи
- ✅ Строковое представление
- ✅ Подзадача без исполнителя
- ✅ Статус по умолчанию
- ✅ Плановые часы по умолчанию
- ✅ Автоматическая установка completed_at
- ✅ Сортировка по order
- ✅ Каскадное удаление

### Permissions (test_permissions.py)

**IsTaskParticipant:**
- ✅ Постановщик имеет доступ
- ✅ Соисполнитель имеет доступ
- ✅ Наблюдатель имеет доступ
- ✅ Исполнитель подзадачи имеет доступ
- ✅ Не участник не имеет доступа
- ✅ Администратор имеет доступ

**IsAssigner:**
- ✅ Постановщик имеет доступ
- ✅ Соисполнитель не имеет доступа
- ✅ Наблюдатель не имеет доступа
- ✅ Исполнитель не имеет доступа
- ✅ Администратор имеет доступ

**IsTaskItemExecutorOrAssigner:**
- ✅ Постановщик может изменять подзадачу
- ✅ Исполнитель может изменить статус
- ✅ Исполнитель не может изменить другие поля
- ✅ Не участник не имеет доступа
- ✅ Администратор имеет доступ

### API Views (test_views.py)

**TestTaskViewSet:**
- ✅ Список задач (только для аутентифицированных)
- ✅ Список задач (только свои)
- ✅ Создание задачи
- ✅ Создание задачи с подзадачами и ролями
- ✅ Получение деталей задачи
- ✅ Получение деталей (только участники)
- ✅ Обновление задачи (только постановщик)
- ✅ Обновление задачи (не постановщик - отказ)
- ✅ Удаление задачи (только постановщик)
- ✅ Удаление задачи (не постановщик - отказ)
- ✅ /tasks/my/ - мои задачи
- ✅ /tasks/my_items/ - мои подзадачи
- ✅ /tasks/assigned_by_me/ - назначенные мной
- ✅ Добавление роли
- ✅ Удаление роли
- ✅ Запрет удаления роли постановщика
- ✅ Добавление подзадачи

**TestTaskItemViewSet:**
- ✅ Список подзадач
- ✅ Получение подзадачи
- ✅ Обновление (постановщик)
- ✅ Обновление статуса (исполнитель)
- ✅ Исполнитель не может изменить другие поля
- ✅ Удаление (только постановщик)
- ✅ Удаление (исполнитель - отказ)

**TestTaskFiltering:**
- ✅ Фильтрация по статусу
- ✅ Фильтрация по постановщику
- ✅ Фильтрация по исполнителю
- ✅ Фильтрация подзадач по статусу

**TestTaskValidation:**
- ✅ Нельзя завершить задачу с незавершенными подзадачами

## Фикстуры

Все фикстуры определены в `conftest.py`:

- `api_client` - клиент для тестирования API
- `user` - основной тестовый пользователь
- `user2` - второй тестовый пользователь
- `user3` - третий тестовый пользователь
- `task` - базовая задача с постановщиком
- `task_with_items` - задача с подзадачами и ролями
- `task_item` - отдельная подзадача

## Проверка покрытия

После запуска тестов с опцией `--cov-report=html` откройте файл:

```bash
open htmlcov/index.html
```

Целевое покрытие согласно ТЗ:
- **Models:** 100%
- **Serializers:** 90%
- **Views:** 80%
- **Permissions:** 100%

## Типичные проблемы

### База данных

Если возникают проблемы с базой данных:

```bash
# Пересоздать базу
docker-compose down -v
docker-compose up -d db
docker-compose exec web python manage.py migrate
```

### Зависимости

Убедитесь, что установлены все зависимости для тестирования:

```txt
pytest==7.4.3
pytest-django==4.7.0
pytest-cov==4.1.0
pytest-mock==3.12.0
```

## Continuous Integration

Тесты автоматически запускаются при push в репозиторий через GitHub Actions (если настроено).

## Дополнительные команды

```bash
# Проверить код на соответствие PEP 8
docker-compose exec web flake8 apps/tasks

# Отформатировать код
docker-compose exec web black apps/tasks

# Проверить типы
docker-compose exec web mypy apps/tasks
```

## Следующие шаги

После завершения Этапа 2 (Задачи), следующие этапы:
- Этап 3: Учет времени (TimeLog)
- Этап 4: Комментарии (TaskComment)
