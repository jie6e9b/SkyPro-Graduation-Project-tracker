# ТЕХНИЧЕСКОЕ ЗАДАНИЕ
## Система управления задачами и учета времени (Task Tracker)

---

**Версия:** 1.0  
**Дата:** 01.11.2025  
**Статус:** Утверждено

---

## СОДЕРЖАНИЕ

1. [Общие сведения](#1-общие-сведения)
2. [Назначение и цели](#2-назначение-и-цели)
3. [Термины и определения](#3-термины-и-определения)
4. [Функциональные требования](#4-функциональные-требования)
5. [Нефункциональные требования](#5-нефункциональные-требования)
6. [Архитектура системы](#6-архитектура-системы)
7. [Модели данных](#7-модели-данных)
8. [API спецификация](#8-api-спецификация)
9. [Права доступа и роли](#9-права-доступа-и-роли)
10. [Требования к безопасности](#10-требования-к-безопасности)
11. [Требования к тестированию](#11-требования-к-тестированию)
12. [Технологический стек](#12-технологический-стек)
13. [Этапы разработки](#13-этапы-разработки)
14. [Критерии приемки](#14-критерии-приемки)

---

## 1. ОБЩИЕ СВЕДЕНИЯ

### 1.1 Наименование системы
**Task Tracker** - Система управления задачами с учетом времени для команд разработки проектной документации.

### 1.2 Назначение документа
Данное техническое задание определяет требования к разработке backend-части системы управления задачами с REST API.

### 1.3 Основание для разработки
Необходимость автоматизации процессов управления задачами в проектных командах с возможностью:
- Декомпозиции крупных задач на подзадачи
- Назначения ответственных исполнителей
- Учета времени на выполнение работ
- Отслеживания прогресса выполнения

---

## 2. НАЗНАЧЕНИЕ И ЦЕЛИ

### 2.1 Целевая аудитория
- Руководители проектов (постановщики задач)
- Инженеры-исполнители
- Менеджеры (наблюдатели)

### 2.2 Основные цели системы
1. Управление проектными задачами с возможностью декомпозиции
2. Контроль выполнения и распределения нагрузки
3. Учет фактических трудозатрат
4. Формирование отчетности по задачам

### 2.3 Бизнес-процессы

#### Сценарий 1: Создание и декомпозиция задачи
1. Постановщик создает основную задачу (например: "Разработка системы вентиляции")
2. Добавляет в задачу список подзадач (TaskItems):
   - "Расчет воздухообмена" → Исполнитель А
   - "Подбор оборудования" → Исполнитель Б
   - "Составление спецификации" → Исполнитель А
3. Указывает соисполнителей и наблюдателей на уровне всей задачи
4. Устанавливает плановые сроки и трудоемкость

#### Сценарий 2: Выполнение работ
1. Исполнитель получает список своих подзадач
2. Меняет статус подзадачи на "В работе"
3. По факту выполнения работ логирует затраченное время
4. Отмечает подзадачу как выполненную
5. Система автоматически пересчитывает прогресс основной задачи

#### Сценарий 3: Контроль выполнения
1. Постановщик видит общий прогресс по задаче
2. Просматривает статусы всех подзадач
3. Анализирует соотношение план/факт по времени
4. Добавляет комментарии и корректировки

---

## 3. ТЕРМИНЫ И ОПРЕДЕЛЕНИЯ

| Термин | Определение |
|--------|-------------|
| **Task (Задача)** | Основная единица работы, содержащая общее описание, цели и список подзадач |
| **TaskItem (Подзадача)** | Элемент декомпозированной задачи с конкретным исполнителем |
| **Постановщик** | Пользователь, создавший задачу и управляющий ею |
| **Исполнитель** | Пользователь, назначенный на выполнение конкретной подзадачи |
| **Соисполнитель** | Пользователь, участвующий в выполнении задачи на вспомогательном уровне |
| **Наблюдатель** | Пользователь с правами просмотра задачи без возможности редактирования |
| **TimeLog** | Запись о затраченном времени на выполнение работы |
| **Трудоемкость** | Плановое или фактическое количество человеко-часов |

---

## 4. ФУНКЦИОНАЛЬНЫЕ ТРЕБОВАНИЯ

### 4.1 Управление задачами (Task)

#### 4.1.1 Создание задачи
**Приоритет:** Высокий

**Описание:**  
Постановщик может создать новую задачу с полным набором атрибутов.

**Входные данные:**
- Название задачи (обязательно, до 255 символов)
- Описание (обязательно, текстовое поле)
- Ссылки на исходные данные (массив URL, опционально)
- Плановые даты начала и окончания (опционально)
- Постановщик (автоматически = текущий пользователь)
- Соисполнители (массив ID пользователей, опционально)
- Наблюдатели (массив ID пользователей, опционально)
- Список подзадач (массив TaskItems, опционально)

**Бизнес-правила:**
- При создании задачи автоматически создается роль "Постановщик" для текущего пользователя
- Статус новой задачи по умолчанию = "new"
- Если указаны соисполнители, для каждого создается роль "co_executor"
- Если указаны наблюдатели, для каждого создается роль "observer"

**Результат:**  
Созданная задача со всеми связанными объектами (роли, подзадачи)

---

#### 4.1.2 Просмотр задачи
**Приоритет:** Высокий

**Описание:**  
Участник задачи может просмотреть все данные задачи, включая подзадачи, комментарии и учет времени.

**Права доступа:**
- Постановщик
- Соисполнители
- Наблюдатели
- Исполнители подзадач

**Отображаемая информация:**
- Все атрибуты задачи
- Список всех подзадач с исполнителями и статусами
- Роли участников
- Прогресс выполнения (%)
- Суммарная трудоемкость (план/факт)
- История комментариев
- Учет времени

---

#### 4.1.3 Редактирование задачи
**Приоритет:** Высокий

**Описание:**  
Только постановщик может редактировать атрибуты основной задачи.

**Редактируемые поля:**
- Название
- Описание
- Ссылки на исходные данные
- Ссылка на результат
- Плановые даты
- Статус задачи

**Бизнес-правила:**
- Фактические даты начала/окончания устанавливаются автоматически при изменении статуса
- При изменении статуса на "completed" проверяется, что все подзадачи завершены
- Удалить задачу может только постановщик
- При удалении задачи каскадно удаляются все подзадачи, комментарии, логи времени

---

#### 4.1.4 Расчет прогресса задачи
**Приоритет:** Средний

**Описание:**  
Система автоматически рассчитывает процент выполнения задачи на основе статусов подзадач.

**Формула расчета:**
```
Прогресс (%) = (Количество выполненных подзадач / Общее количество подзадач) × 100
```

**Правила:**
- Если подзадач нет, прогресс = 0%
- Учитываются только подзадачи со статусом "completed"
- Пересчет происходит при каждом изменении статуса подзадачи

---

### 4.2 Управление подзадачами (TaskItem)

#### 4.2.1 Добавление подзадачи
**Приоритет:** Высокий

**Описание:**  
Постановщик может добавить подзадачу к существующей задаче.

**Входные данные:**
- ID основной задачи (обязательно)
- Название подзадачи (обязательно, до 255 символов)
- Описание (опционально)
- Исполнитель (ID пользователя, опционально)
- Плановая трудоемкость в часах (опционально, по умолчанию 0)
- Порядковый номер (опционально, по умолчанию в конец списка)

**Бизнес-правила:**
- Подзадача может быть без исполнителя (назначить позже)
- При создании статус = "todo"
- Исполнитель автоматически получает доступ к основной задаче

---

#### 4.2.2 Изменение статуса подзадачи
**Приоритет:** Высокий

**Описание:**  
Исполнитель или постановщик может изменить статус подзадачи.

**Возможные статусы:**
- `todo` - К выполнению
- `in_progress` - В работе
- `completed` - Выполнена
- `blocked` - Заблокирована

**Права доступа:**
- Исполнитель подзадачи - может изменить статус
- Постановщик основной задачи - может изменить статус

**Бизнес-правила:**
- При переводе в статус "completed" автоматически устанавливается `completed_at`
- При изменении статуса пересчитывается прогресс основной задачи
- Нельзя перевести в "completed" если есть незаполненные обязательные поля

---

#### 4.2.3 Назначение/смена исполнителя
**Приоритет:** Высокий

**Описание:**  
Постановщик может назначить или сменить исполнителя подзадачи.

**Бизнес-правила:**
- Можно назначить только одного исполнителя на подзадачу
- При смене исполнителя старый исполнитель теряет доступ к подзадаче (если не участвует в других подзадачах этой задачи)
- Новый исполнитель получает уведомление (если реализована система уведомлений)

---

#### 4.2.4 Удаление подзадачи
**Приоритет:** Средний

**Описание:**  
Постановщик может удалить подзадачу.

**Бизнес-правила:**
- Удаляются все связанные логи времени для этой подзадачи
- Пересчитывается прогресс основной задачи
- Нельзя удалить подзадачу со статусом "completed" (нужно сначала изменить статус)

---

#### 4.2.5 Изменение порядка подзадач
**Приоритет:** Низкий

**Описание:**  
Постановщик может изменить порядок отображения подзадач.

**Входные данные:**
- Массив ID подзадач в нужном порядке

**Результат:**
- Обновляется поле `order` для каждой подзадачи

---

### 4.3 Управление ролями

#### 4.3.1 Назначение роли
**Приоритет:** Высокий

**Описание:**  
Постановщик может назначить пользователю роль в задаче.

**Типы ролей:**
- `assigner` - Постановщик (может быть только один, не может быть изменен)
- `co_executor` - Соисполнитель (может быть несколько)
- `observer` - Наблюдатель (может быть несколько)

**Права доступа:**
- Только постановщик может назначать роли

**Бизнес-правила:**
- Нельзя назначить второго постановщика
- Один пользователь может иметь только одну роль в задаче
- При назначении роли пользователь получает доступ к задаче

---

#### 4.3.2 Удаление роли
**Приоритет:** Средний

**Описание:**  
Постановщик может удалить роль пользователя.

**Бизнес-правила:**
- Нельзя удалить роль постановщика
- При удалении роли пользователь теряет доступ к задаче (если не является исполнителем подзадач)

---

### 4.4 Учет времени (TimeLog)

#### 4.4.1 Добавление записи времени
**Приоритет:** Высокий

**Описание:**  
Участник задачи может зафиксировать затраченное время.

**Входные данные:**
- ID задачи (обязательно)
- ID подзадачи (опционально - если время относится к конкретной подзадаче)
- Количество часов (обязательно, decimal)
- Дата работы (обязательно)
- Описание работы (опционально)

**Права доступа:**
- Постановщик
- Соисполнители
- Исполнители подзадач

**Бизнес-правила:**
- Пользователь может логировать время только на задачи, в которых он участвует
- Дата работы не может быть в будущем
- Количество часов должно быть положительным числом
- Если указана подзадача, запись привязывается и к основной задаче, и к подзадаче

---

#### 4.4.2 Редактирование записи времени
**Приоритет:** Средний

**Описание:**  
Пользователь может отредактировать свою запись времени.

**Бизнес-правила:**
- Редактировать можно только свои записи
- Постановщик может редактировать любые записи в своих задачах

---

#### 4.4.3 Удаление записи времени
**Приоритет:** Средний

**Описание:**  
Пользователь может удалить свою запись времени.

**Бизнес-правила:**
- Удалять можно только свои записи
- Постановщик может удалять любые записи в своих задачах

---

#### 4.4.4 Просмотр учета времени
**Приоритет:** Высокий

**Описание:**  
Участники задачи могут просматривать учет времени.

**Отображаемая информация:**
- Все записи времени по задаче
- Группировка по пользователям
- Группировка по подзадачам
- Суммарное время (план/факт)
- Разница между планом и фактом

**Фильтры:**
- По пользователю
- По подзадаче
- По диапазону дат

---

### 4.5 Комментарии

#### 4.5.1 Добавление комментария
**Приоритет:** Средний

**Описание:**  
Участник задачи может добавить комментарий к задаче или подзадаче.

**Входные данные:**
- ID задачи (обязательно)
- ID подзадачи (опционально)
- Текст комментария (обязательно)

**Права доступа:**
- Все участники задачи

**Бизнес-правила:**
- Автор комментария = текущий пользователь
- Комментарий сохраняется с временной меткой

---

#### 4.5.2 Редактирование комментария
**Приоритет:** Низкий

**Описание:**  
Автор может отредактировать свой комментарий.

**Бизнес-правила:**
- Редактировать можно только свои комментарии
- При редактировании обновляется поле `updated_at`

---

#### 4.5.3 Удаление комментария
**Приоритет:** Низкий

**Описание:**  
Автор или постановщик может удалить комментарий.

**Права доступа:**
- Автор комментария
- Постановщик задачи

---

### 4.6 Фильтрация и поиск

#### 4.6.1 Фильтрация списка задач
**Приоритет:** Высокий

**Описание:**  
Пользователь может отфильтровать список задач по различным критериям.

**Доступные фильтры:**
- По статусу задачи
- По постановщику
- По исполнителю (в любой из подзадач)
- По диапазону дат создания
- По диапазону плановых дат окончания
- По наличию просроченных задач
- По моему участию (где я участник в любой роли)

---

#### 4.6.2 Поиск задач
**Приоритет:** Средний

**Описание:**  
Пользователь может найти задачи по текстовому запросу.

**Поиск выполняется по полям:**
- Название задачи
- Описание задачи
- Названия подзадач

---

#### 4.6.3 Персональные представления
**Приоритет:** Высокий

**Описание:**  
Пользователь может получить списки задач, относящихся лично к нему.

**Типы представлений:**
- **Мои задачи** - все задачи, где я участник (любая роль)
- **Мои подзадачи** - все подзадачи, где я исполнитель
- **Назначенные мной** - задачи, где я постановщик
- **На контроле** - задачи, где я наблюдатель

---

### 4.7 Статистика и отчеты

#### 4.7.1 Статистика по задаче
**Приоритет:** Средний

**Описание:**  
Участники могут просмотреть статистику по конкретной задаче.

**Отображаемая информация:**
- Общий прогресс выполнения (%)
- Количество подзадач по статусам
- Плановая трудоемкость (сумма)
- Фактическая трудоемкость (сумма)
- Отклонение план/факт
- Распределение нагрузки по исполнителям
- Даты (план/факт начала и окончания)
- Среднее время выполнения подзадачи

---

#### 4.7.2 Личная статистика
**Приоритет:** Низкий

**Описание:**  
Пользователь может просмотреть свою личную статистику.

**Отображаемая информация:**
- Количество активных подзадач
- Количество завершенных подзадач за период
- Общее затраченное время за период
- Среднее время выполнения подзадачи
- Список просроченных задач

---

### 4.8 Уведомления (опционально)

#### 4.8.1 События для уведомлений
**Приоритет:** Низкий (опционально)

**Описание:**  
Система может отправлять уведомления пользователям при определенных событиях.

**События:**
- Назначение на подзадачу
- Изменение статуса подзадачи
- Новый комментарий к задаче
- Приближение дедлайна
- Просрочка задачи

**Каналы доставки:**
- Email (опционально)
- Внутренние уведомления (опционально)

---

## 5. НЕФУНКЦИОНАЛЬНЫЕ ТРЕБОВАНИЯ

### 5.1 Производительность

#### 5.1.1 Время отклика
- Получение списка задач: < 500 мс
- Получение деталей задачи: < 300 мс
- Создание/обновление задачи: < 1000 мс
- Поисковые запросы: < 1000 мс

#### 5.1.2 Масштабируемость
- Система должна поддерживать до 10,000 задач
- До 1,000 активных пользователей одновременно
- До 100,000 записей времени

---

### 5.2 Надежность

#### 5.2.1 Доступность
- Целевая доступность: 99.5% (uptime)
- Плановое время обслуживания: не более 4 часов в месяц

#### 5.2.2 Обработка ошибок
- Все ошибки должны логироваться
- API должен возвращать понятные сообщения об ошибках
- Транзакционность операций (откат при ошибке)

---

### 5.3 Безопасность

#### 5.3.1 Аутентификация
- JWT токены для аутентификации
- Refresh токены для продления сессии
- Хеширование паролей (bcrypt или Argon2)

#### 5.3.2 Авторизация
- Ролевая модель доступа
- Проверка прав на уровне объектов
- Защита от несанкционированного доступа к данным

#### 5.3.3 Защита данных
- HTTPS для всех API запросов
- Валидация всех входных данных
- Защита от SQL-инъекций
- Защита от XSS атак
- Rate limiting для предотвращения DDoS

---

### 5.4 Юзабилити API

#### 5.4.1 Документация
- Автогенерируемая документация (Swagger/ReDoc)
- Примеры запросов и ответов
- Описание всех эндпоинтов
- Коды ошибок и их значения

#### 5.4.2 Версионирование API
- Версия API в URL: `/api/v1/`
- Обратная совместимость при обновлениях

---

### 5.5 Совместимость

#### 5.5.1 Браузеры
- API должно работать с любыми современными клиентами

#### 5.5.2 Мобильные устройства
- API должно быть оптимизировано для работы с мобильными приложениями

---

### 5.6 Поддерживаемость

#### 5.6.1 Код
- Соблюдение PEP 8
- Форматирование кода через Black
- Комментирование сложных участков
- Type hints для Python функций

#### 5.6.2 Логирование
- Логирование всех важных операций
- Уровни логирования: DEBUG, INFO, WARNING, ERROR
- Ротация логов

---

## 6. АРХИТЕКТУРА СИСТЕМЫ

### 6.1 Общая архитектура

```
┌─────────────────────────────────────────────────────────────┐
│                    Frontend / Mobile App                     │
│                    (не входит в данное ТЗ)                   │
└──────────────────────────┬──────────────────────────────────┘
                           │ HTTPS / REST API
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                       API Gateway                            │
│                  (Django + DRF)                              │
│  ┌─────────────┬──────────────┬──────────────┬────────────┐ │
│  │   Auth      │    Tasks     │   TimeLog    │  Reports   │ │
│  │   Module    │    Module    │    Module    │   Module   │ │
│  └─────────────┴──────────────┴──────────────┴────────────┘ │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                      PostgreSQL Database                     │
│  ┌──────────┬───────────┬──────────┬──────────┬──────────┐  │
│  │  Users   │   Tasks   │TaskItems │ TimeLog  │ Comments │  │
│  └──────────┴───────────┴──────────┴──────────┴──────────┘  │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                    Redis Cache (опционально)                 │
└─────────────────────────────────────────────────────────────┘
```

---

### 6.2 Структура Django проекта

```
task_tracker/
│
├── config/                          # Конфигурация проекта
│   ├── __init__.py
│   ├── settings/
│   │   ├── __init__.py
│   │   ├── base.py                  # Общие настройки
│   │   ├── development.py           # Dev окружение
│   │   ├── production.py            # Prod окружение
│   │   └── testing.py               # Тестовое окружение
│   ├── urls.py                      # Главный роутинг
│   ├── wsgi.py
│   └── asgi.py
│
├── apps/                            # Приложения Django
│   │
│   ├── users/                       # Управление пользователями
│   │   ├── __init__.py
│   │   ├── models.py                # User модель
│   │   ├── serializers.py           # Сериализаторы
│   │   ├── views.py                 # ViewSets
│   │   ├── permissions.py           # Permissions
│   │   ├── urls.py
│   │   ├── admin.py
│   │   ├── managers.py              # Custom managers
│   │   └── tests/
│   │       ├── __init__.py
│   │       ├── test_models.py
│   │       ├── test_views.py
│   │       └── test_serializers.py
│   │
│   ├── tasks/                       # Основной модуль задач
│   │   ├── __init__.py
│   │   ├── models.py                # Task, TaskItem, TaskRole
│   │   ├── serializers.py
│   │   ├── views.py
│   │   ├── permissions.py
│   │   ├── filters.py               # Django-filter
│   │   ├── signals.py               # Signals для автоматизации
│   │   ├── services.py              # Бизнес-логика
│   │   ├── urls.py
│   │   ├── admin.py
│   │   └── tests/
│   │       ├── __init__.py
│   │       ├── test_models.py
│   │       ├── test_views.py
│   │       ├── test_permissions.py
│   │       ├── test_serializers.py
│   │       └── fixtures.py          # Тестовые данные
│   │
│   ├── timelogs/                    # Учет времени
│   │   ├── __init__.py
│   │   ├── models.py                # TimeLog
│   │   ├── serializers.py
│   │   ├── views.py
│   │   ├── permissions.py
│   │   ├── urls.py
│   │   ├── admin.py
│   │   └── tests/
│   │
│   ├── comments/                    # Комментарии
│   │   ├── __init__.py
│   │   ├── models.py                # TaskComment
│   │   ├── serializers.py
│   │   ├── views.py
│   │   ├── permissions.py
│   │   ├── urls.py
│   │   ├── admin.py
│   │   └── tests/
│   │
│   └── common/                      # Общие компоненты
│       ├── __init__.py
│       ├── mixins.py                # Переиспользуемые миксины
│       ├── pagination.py            # Кастомная пагинация
│       ├── exceptions.py            # Кастомные исключения
│       ├── validators.py            # Валидаторы
│       └── utils.py                 # Утилиты
│
├── docs/                            # Документация
│   ├── api/
│   ├── architecture/
│   └── deployment/
│
├── requirements/                    # Зависимости
│   ├── base.txt                     # Общие для всех окружений
│   ├── development.txt              # Для разработки
│   ├── production.txt               # Для продакшена
│   └── testing.txt                  # Для тестирования
│
├── scripts/                         # Вспомогательные скрипты
│   ├── init_db.py
│   ├── seed_data.py                 # Заполнение тестовыми данными
│   └── backup.py
│
├── static/                          # Статические файлы (если нужны)
├── media/                           # Загружаемые файлы
│
├── .env.example                     # Пример переменных окружения
├── .gitignore
├── .flake8                          # Конфиг flake8
├── .black                           # Конфиг black
├── pytest.ini                       # Конфиг pytest
├── docker-compose.yml               # Docker Compose
├── Dockerfile                       # Dockerfile
├── manage.py
└── README.md
```

---

### 6.3 Слои приложения

#### 6.3.1 Presentation Layer (API)
- **Views/ViewSets:** Обработка HTTP запросов
- **Serializers:** Валидация и сериализация данных
- **Permissions:** Проверка прав доступа

#### 6.3.2 Business Logic Layer
- **Services:** Бизнес-логика (services.py)
- **Signals:** Автоматизация процессов
- **Validators:** Бизнес-валидация

#### 6.3.3 Data Access Layer
- **Models:** ORM модели Django
- **Managers:** Custom менеджеры запросов
- **QuerySets:** Оптимизированные запросы

---

## 7. МОДЕЛИ ДАННЫХ

### 7.1 Диаграмма базы данных

```
┌─────────────────────┐
│       User          │
│─────────────────────│
│ id (PK)             │
│ email               │
│ password            │
│ first_name          │
│ last_name           │
│ position            │
│ department          │
│ is_active           │
│ date_joined         │
└──────┬──────────────┘
       │
       │ 1:N
       │
       ├─────────────────────────────────────┐
       │                                     │
       ▼                                     ▼
┌──────────────────────┐            ┌─────────────────────┐
│      Task            │            │     TaskRole        │
│──────────────────────│◄───────────│─────────────────────│
│ id (PK)              │    1:N     │ id (PK)             │
│ title                │            │ task_id (FK)        │
│ description          │            │ user_id (FK)        │
│ source_links (JSON)  │            │ role                │
│ result_link          │            │ assigned_at         │
│ status               │            └─────────────────────┘
│ planned_start_date   │
│ actual_start_date    │
│ planned_end_date     │
│ actual_end_date      │
│ created_at           │
│ updated_at           │
└──────┬───────────────┘
       │
       │ 1:N
       │
       ├───────────────┬────────────────┬──────────────────┐
       │               │                │                  │
       ▼               ▼                ▼                  ▼
┌──────────────┐ ┌────────────┐ ┌──────────────┐ ┌────────────────┐
│  TaskItem    │ │  TimeLog   │ │ TaskComment  │ │ TaskAttachment │
│──────────────│ │────────────│ │──────────────│ │────────────────│
│ id (PK)      │ │ id (PK)    │ │ id (PK)      │ │ id (PK)        │
│ task_id (FK) │ │ task_id FK │ │ task_id (FK) │ │ task_id (FK)   │
│ title        │ │ item_id FK │ │ item_id (FK) │ │ file           │
│ description  │ │ user_id FK │ │ author_id FK │ │ filename       │
│ executor FK  │ │ hours      │ │ text         │ │ uploaded_by FK │
│ status       │ │ date       │ │ created_at   │ │ uploaded_at    │
│ planned_hrs  │ │ description│ │ updated_at   │ └────────────────┘
│ order        │ │ created_at │ └──────────────┘
│ completed_at │ └────────────┘
│ created_at   │
│ updated_at   │
└──────────────┘
```

---

### 7.2 Описание моделей

#### 7.2.1 User (Пользователь)

```python
class User(AbstractUser):
    """
    Расширенная модель пользователя.
    Наследуется от AbstractUser Django.
    """
    email = models.EmailField(unique=True)
    first_name = models.CharField(max_length=150)
    last_name = models.CharField(max_length=150)
    position = models.CharField(max_length=255, blank=True)
    department = models.CharField(max_length=255, blank=True)
    
    USERNAME_FIELD = 'email'
    REQUIRED_FIELDS = ['first_name', 'last_name']
```

**Поля:**
| Поле | Тип | Описание | Обязательное | Уникальное |
|------|-----|----------|--------------|------------|
| id | Integer | Первичный ключ | Да | Да |
| email | String(254) | Email пользователя | Да | Да |
| password | String(128) | Хешированный пароль | Да | Нет |
| first_name | String(150) | Имя | Да | Нет |
| last_name | String(150) | Фамилия | Да | Нет |
| position | String(255) | Должность | Нет | Нет |
| department | String(255) | Отдел | Нет | Нет |
| is_active | Boolean | Активный | Да | Нет |
| is_staff | Boolean | Сотрудник | Да | Нет |
| date_joined | DateTime | Дата регистрации | Да | Нет |

---

#### 7.2.2 Task (Задача)

```python
class Task(models.Model):
    """Основная задача"""
    title = models.CharField(max_length=255)
    description = models.TextField()
    source_links = models.JSONField(default=list, blank=True)
    result_link = models.URLField(blank=True, null=True)
    
    STATUS_CHOICES = [
        ('new', 'Новая'),
        ('in_progress', 'В работе'),
        ('review', 'На проверке'),
        ('completed', 'Завершена'),
        ('cancelled', 'Отменена'),
    ]
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default='new')
    
    planned_start_date = models.DateField(null=True, blank=True)
    actual_start_date = models.DateField(null=True, blank=True)
    planned_end_date = models.DateField(null=True, blank=True)
    actual_end_date = models.DateField(null=True, blank=True)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
```

**Поля:**
| Поле | Тип | Описание | Обязательное | Индекс |
|------|-----|----------|--------------|--------|
| id | Integer | Первичный ключ | Да | PK |
| title | String(255) | Название задачи | Да | Index |
| description | Text | Описание задачи | Да | Нет |
| source_links | JSON | Массив ссылок на исходники | Нет | Нет |
| result_link | URL | Ссылка на результат | Нет | Нет |
| status | String(20) | Статус задачи | Да | Index |
| planned_start_date | Date | План дата начала | Нет | Index |
| actual_start_date | Date | Факт дата начала | Нет | Нет |
| planned_end_date | Date | План дата окончания | Нет | Index |
| actual_end_date | Date | Факт дата окончания | Нет | Нет |
| created_at | DateTime | Дата создания | Да | Index |
| updated_at | DateTime | Дата обновления | Да | Нет |

**Вычисляемые поля (свойства):**
- `progress_percentage` - процент выполнения
- `total_planned_hours` - сумма планов по подзадачам
- `total_spent_hours` - сумма факта по всем TimeLog

**Индексы:**
```sql
CREATE INDEX idx_task_status ON tasks_task(status);
CREATE INDEX idx_task_created ON tasks_task(created_at DESC);
CREATE INDEX idx_task_planned_end ON tasks_task(planned_end_date);
```

---

#### 7.2.3 TaskRole (Роль в задаче)

```python
class TaskRole(models.Model):
    """Роли участников задачи"""
    task = models.ForeignKey(Task, on_delete=models.CASCADE, related_name='roles')
    user = models.ForeignKey(User, on_delete=models.CASCADE, related_name='task_roles')
    
    ROLE_CHOICES = [
        ('assigner', 'Постановщик'),
        ('co_executor', 'Соисполнитель'),
        ('observer', 'Наблюдатель'),
    ]
    role = models.CharField(max_length=20, choices=ROLE_CHOICES)
    assigned_at = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        unique_together = ('task', 'user', 'role')
```

**Поля:**
| Поле | Тип | Описание | Обязательное |
|------|-----|----------|--------------|
| id | Integer | Первичный ключ | Да |
| task_id | ForeignKey | Ссылка на Task | Да |
| user_id | ForeignKey | Ссылка на User | Да |
| role | String(20) | Роль (assigner/co_executor/observer) | Да |
| assigned_at | DateTime | Дата назначения | Да |

**Ограничения:**
- Уникальная комбинация (task, user, role)
- Каскадное удаление при удалении Task или User

**Индексы:**
```sql
CREATE UNIQUE INDEX idx_task_role_unique ON tasks_taskrole(task_id, user_id, role);
CREATE INDEX idx_task_role_user ON tasks_taskrole(user_id);
```

---

#### 7.2.4 TaskItem (Подзадача)

```python
class TaskItem(models.Model):
    """Элемент задачи (подзадача)"""
    task = models.ForeignKey(Task, on_delete=models.CASCADE, related_name='task_items')
    title = models.CharField(max_length=255)
    description = models.TextField(blank=True)
    
    executor = models.ForeignKey(
        User, 
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='assigned_task_items'
    )
    
    STATUS_CHOICES = [
        ('todo', 'К выполнению'),
        ('in_progress', 'В работе'),
        ('completed', 'Выполнена'),
        ('blocked', 'Заблокирована'),
    ]
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default='todo')
    
    planned_hours = models.DecimalField(max_digits=6, decimal_places=2, default=0)
    order = models.PositiveIntegerField(default=0)
    
    completed_at = models.DateTimeField(null=True, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
```

**Поля:**
| Поле | Тип | Описание | Обязательное |
|------|-----|----------|--------------|
| id | Integer | Первичный ключ | Да |
| task_id | ForeignKey | Ссылка на Task | Да |
| title | String(255) | Название подзадачи | Да |
| description | Text | Описание | Нет |
| executor_id | ForeignKey | Ссылка на User (исполнитель) | Нет |
| status | String(20) | Статус | Да |
| planned_hours | Decimal(6,2) | Плановая трудоемкость | Да |
| order | Integer | Порядковый номер | Да |
| completed_at | DateTime | Дата завершения | Нет |
| created_at | DateTime | Дата создания | Да |
| updated_at | DateTime | Дата обновления | Да |

**Вычисляемые поля:**
- `spent_hours` - сумма TimeLog для этой подзадачи

**Индексы:**
```sql
CREATE INDEX idx_taskitem_task ON tasks_taskitem(task_id, order);
CREATE INDEX idx_taskitem_executor ON tasks_taskitem(executor_id);
CREATE INDEX idx_taskitem_status ON tasks_taskitem(status);
```

---

#### 7.2.5 TimeLog (Учет времени)

```python
class TimeLog(models.Model):
    """Учет времени"""
    task = models.ForeignKey(Task, on_delete=models.CASCADE, related_name='time_logs')
    task_item = models.ForeignKey(
        TaskItem, 
        on_delete=models.CASCADE,
        null=True,
        blank=True,
        related_name='time_logs'
    )
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    hours = models.DecimalField(max_digits=5, decimal_places=2)
    date = models.DateField()
    description = models.TextField(blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
```

**Поля:**
| Поле | Тип | Описание | Обязательное |
|------|-----|----------|--------------|
| id | Integer | Первичный ключ | Да |
| task_id | ForeignKey | Ссылка на Task | Да |
| task_item_id | ForeignKey | Ссылка на TaskItem | Нет |
| user_id | ForeignKey | Ссылка на User | Да |
| hours | Decimal(5,2) | Количество часов | Да |
| date | Date | Дата работы | Да |
| description | Text | Описание работы | Нет |
| created_at | DateTime | Дата создания записи | Да |

**Индексы:**
```sql
CREATE INDEX idx_timelog_task ON timelogs_timelog(task_id);
CREATE INDEX idx_timelog_taskitem ON timelogs_timelog(task_item_id);
CREATE INDEX idx_timelog_user ON timelogs_timelog(user_id);
CREATE INDEX idx_timelog_date ON timelogs_timelog(date DESC);
```

---

#### 7.2.6 TaskComment (Комментарий)

```python
class TaskComment(models.Model):
    """Комментарий к задаче"""
    task = models.ForeignKey(Task, on_delete=models.CASCADE, related_name='comments')
    task_item = models.ForeignKey(
        TaskItem,
        on_delete=models.CASCADE,
        null=True,
        blank=True,
        related_name='comments'
    )
    author = models.ForeignKey(User, on_delete=models.CASCADE)
    text = models.TextField()
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
```

**Поля:**
| Поле | Тип | Описание | Обязательное |
|------|-----|----------|--------------|
| id | Integer | Первичный ключ | Да |
| task_id | ForeignKey | Ссылка на Task | Да |
| task_item_id | ForeignKey | Ссылка на TaskItem | Нет |
| author_id | ForeignKey | Автор комментария | Да |
| text | Text | Текст комментария | Да |
| created_at | DateTime | Дата создания | Да |
| updated_at | DateTime | Дата обновления | Да |

---

#### 7.2.7 TaskAttachment (Вложение) - опционально

```python
class TaskAttachment(models.Model):
    """Вложенный файл"""
    task = models.ForeignKey(Task, on_delete=models.CASCADE, related_name='attachments')
    file = models.FileField(upload_to='task_attachments/%Y/%m/')
    filename = models.CharField(max_length=255)
    uploaded_by = models.ForeignKey(User, on_delete=models.SET_NULL, null=True)
    uploaded_at = models.DateTimeField(auto_now_add=True)
```

---

## 8. API СПЕЦИФИКАЦИЯ

### 8.1 Общие правила API

#### 8.1.1 Базовый URL
```
https://api.tasktracker.com/api/v1/
```

#### 8.1.2 Формат данных
- **Request:** `application/json`
- **Response:** `application/json`

#### 8.1.3 Аутентификация
```http
Authorization: Bearer {access_token}
```

#### 8.1.4 Коды ответов

| Код | Значение | Описание |
|-----|----------|----------|
| 200 | OK | Успешный запрос |
| 201 | Created | Ресурс создан |
| 204 | No Content | Успешное удаление |
| 400 | Bad Request | Ошибка валидации |
| 401 | Unauthorized | Не авторизован |
| 403 | Forbidden | Доступ запрещен |
| 404 | Not Found | Ресурс не найден |
| 500 | Internal Server Error | Ошибка сервера |

#### 8.1.5 Пагинация
```json
{
  "count": 150,
  "next": "https://api.tasktracker.com/api/v1/tasks/?page=2",
  "previous": null,
  "results": [...]
}
```

**Параметры:**
- `page` - номер страницы (default: 1)
- `page_size` - размер страницы (default: 20, max: 100)

---

### 8.2 Аутентификация

#### 8.2.1 Регистрация

```http
POST /api/v1/auth/register/
```

**Request Body:**
```json
{
  "email": "user@example.com",
  "password": "SecurePass123!",
  "password_confirm": "SecurePass123!",
  "first_name": "Иван",
  "last_name": "Петров",
  "position": "Инженер-проектировщик",
  "department": "Отдел ВК"
}
```

**Response (201):**
```json
{
  "id": 1,
  "email": "user@example.com",
  "first_name": "Иван",
  "last_name": "Петров",
  "position": "Инженер-проектировщик",
  "department": "Отдел ВК",
  "date_joined": "2025-11-01T10:00:00Z"
}
```

---

#### 8.2.2 Вход (получение токенов)

```http
POST /api/v1/auth/login/
```

**Request Body:**
```json
{
  "email": "user@example.com",
  "password": "SecurePass123!"
}
```

**Response (200):**
```json
{
  "access": "eyJhbGciOiJIUzI1NiIs...",
  "refresh": "eyJhbGciOiJIUzI1NiIs...",
  "user": {
    "id": 1,
    "email": "user@example.com",
    "first_name": "Иван",
    "last_name": "Петров",
    "position": "Инженер-проектировщик"
  }
}
```

---

#### 8.2.3 Обновление токена

```http
POST /api/v1/auth/refresh/
```

**Request Body:**
```json
{
  "refresh": "eyJhbGciOiJIUzI1NiIs..."
}
```

**Response (200):**
```json
{
  "access": "eyJhbGciOiJIUzI1NiIs..."
}
```

---

#### 8.2.4 Выход

```http
POST /api/v1/auth/logout/
```

**Request Body:**
```json
{
  "refresh": "eyJhbGciOiJIUzI1NiIs..."
}
```

**Response (204):** No Content

---

### 8.3 Пользователи

#### 8.3.1 Список пользователей

```http
GET /api/v1/users/
```

**Query Parameters:**
- `department` - фильтр по отделу
- `search` - поиск по имени/email
- `is_active` - только активные (true/false)

**Response (200):**
```json
{
  "count": 50,
  "next": null,
  "previous": null,
  "results": [
    {
      "id": 1,
      "email": "user@example.com",
      "first_name": "Иван",
      "last_name": "Петров",
      "full_name": "Иван Петров",
      "position": "Инженер-проектировщик",
      "department": "Отдел ВК",
      "is_active": true
    }
  ]
}
```

---

#### 8.3.2 Текущий пользователь

```http
GET /api/v1/users/me/
```

**Response (200):**
```json
{
  "id": 1,
  "email": "user@example.com",
  "first_name": "Иван",
  "last_name": "Петров",
  "full_name": "Иван Петров",
  "position": "Инженер-проектировщик",
  "department": "Отдел ВК",
  "is_active": true,
  "date_joined": "2025-01-15T10:00:00Z"
}
```

---

#### 8.3.3 Профиль пользователя

```http
GET /api/v1/users/{id}/
```

**Response (200):**
```json
{
  "id": 1,
  "email": "user@example.com",
  "first_name": "Иван",
  "last_name": "Петров",
  "full_name": "Иван Петров",
  "position": "Инженер-проектировщик",
  "department": "Отдел ВК",
  "is_active": true,
  "statistics": {
    "active_tasks": 5,
    "completed_tasks": 23,
    "total_hours_this_month": 120.5
  }
}
```

---

### 8.4 Задачи

#### 8.4.1 Список задач

```http
GET /api/v1/tasks/
```

**Query Parameters:**
- `status` - фильтр по статусу (new, in_progress, review, completed, cancelled)
- `assigner` - ID постановщика
- `executor` - ID исполнителя (в любой подзадаче)
- `search` - поиск по названию/описанию
- `created_after` - дата создания от (YYYY-MM-DD)
- `created_before` - дата создания до
- `planned_end_before` - плановая дата окончания до
- `overdue` - только просроченные (true)
- `ordering` - сортировка (created_at, -created_at, planned_end_date, title)

**Response (200):**
```json
{
  "count": 100,
  "next": "https://api.tasktracker.com/api/v1/tasks/?page=2",
  "previous": null,
  "results": [
    {
      "id": 1,
      "title": "Разработка системы вентиляции",
      "description": "Проектирование системы вентиляции для БЦ",
      "status": "in_progress",
      "progress_percentage": 45.5,
      "planned_start_date": "2025-11-01",
      "planned_end_date": "2025-11-30",
      "total_planned_hours": 120,
      "total_spent_hours": 54.5,
      "task_items_count": 8,
      "completed_items_count": 3,
      "assigner": {
        "id": 2,
        "full_name": "Анна Смирнова"
      },
      "created_at": "2025-11-01T09:00:00Z",
      "updated_at": "2025-11-15T14:30:00Z"
    }
  ]
}
```

---

#### 8.4.2 Детали задачи

```http
GET /api/v1/tasks/{id}/
```

**Response (200):**
```json
{
  "id": 1,
  "title": "Разработка системы вентиляции",
  "description": "Проектирование системы вентиляции для БЦ. Необходимо выполнить расчеты, подобрать оборудование и составить спецификацию.",
  "source_links": [
    "https://drive.google.com/file/xxx",
    "https://docs.company.com/spec-123"
  ],
  "result_link": "https://drive.google.com/file/result-xxx",
  "status": "in_progress",
  "planned_start_date": "2025-11-01",
  "actual_start_date": "2025-11-01",
  "planned_end_date": "2025-11-30",
  "actual_end_date": null,
  "progress_percentage": 45.5,
  "total_planned_hours": 120,
  "total_spent_hours": 54.5,
  "roles": [
    {
      "id": 1,
      "user": {
        "id": 2,
        "full_name": "Анна Смирнова",
        "position": "Главный инженер"
      },
      "role": "assigner",
      "assigned_at": "2025-11-01T09:00:00Z"
    },
    {
      "id": 2,
      "user": {
        "id": 5,
        "full_name": "Петр Козлов",
        "position": "Старший инженер"
      },
      "role": "co_executor",
      "assigned_at": "2025-11-01T09:00:00Z"
    }
  ],
  "task_items": [
    {
      "id": 1,
      "title": "Расчет воздухообмена",
      "description": "Выполнить расчет необходимого воздухообмена по всем помещениям",
      "executor": {
        "id": 3,
        "full_name": "Иван Петров"
      },
      "status": "completed",
      "planned_hours": 24,
      "spent_hours": 26.5,
      "order": 0,
      "completed_at": "2025-11-10T17:00:00Z",
      "created_at": "2025-11-01T09:00:00Z",
      "updated_at": "2025-11-10T17:00:00Z"
    },
    {
      "id": 2,
      "title": "Подбор оборудования",
      "description": "Подобрать вентиляционное оборудование согласно расчетам",
      "executor": {
        "id": 4,
        "full_name": "Мария Иванова"
      },
      "status": "in_progress",
      "planned_hours": 40,
      "spent_hours": 28,
      "order": 1,
      "completed_at": null,
      "created_at": "2025-11-01T09:00:00Z",
      "updated_at": "2025-11-15T14:30:00Z"
    }
  ],
  "created_at": "2025-11-01T09:00:00Z",
  "updated_at": "2025-11-15T14:30:00Z"
}
```

---

#### 8.4.3 Создание задачи

```http
POST /api/v1/tasks/
```

**Request Body:**
```json
{
  "title": "Разработка системы вентиляции",
  "description": "Проектирование системы вентиляции для БЦ",
  "source_links": [
    "https://drive.google.com/file/xxx",
    "https://docs.company.com/spec-123"
  ],
  "planned_start_date": "2025-11-01",
  "planned_end_date": "2025-11-30",
  "co_executors": [5, 7],
  "observers": [8],
  "task_items": [
    {
      "title": "Расчет воздухообмена",
      "description": "Выполнить расчет необходимого воздухообмена",
      "executor": 3,
      "planned_hours": 24
    },
    {
      "title": "Подбор оборудования",
      "executor": 4,
      "planned_hours": 40
    }
  ]
}
```

**Response (201):**
```json
{
  "id": 1,
  "title": "Разработка системы вентиляции",
  ...
}
```

**Errors (400):**
```json
{
  "title": ["Это поле обязательно."],
  "description": ["Это поле обязательно."],
  "task_items": [
    {
      "executor": ["Пользователь с таким ID не существует."]
    }
  ]
}
```

---

#### 8.4.4 Обновление задачи

```http
PUT /api/v1/tasks/{id}/
PATCH /api/v1/tasks/{id}/
```

**Request Body (PATCH):**
```json
{
  "status": "completed",
  "result_link": "https://drive.google.com/file/result-xxx",
  "actual_end_date": "2025-11-28"
}
```

**Response (200):** Обновленная задача

---

#### 8.4.5 Удаление задачи

```http
DELETE /api/v1/tasks/{id}/
```

**Response (204):** No Content

---

### 8.5 Подзадачи

#### 8.5.1 Список подзадач задачи

```http
GET /api/v1/tasks/{task_id}/items/
```

**Response (200):**
```json
[
  {
    "id": 1,
    "title": "Расчет воздухообмена",
    "description": "...",
    "executor": {...},
    "status": "completed",
    "planned_hours": 24,
    "spent_hours": 26.5,
    "order": 0,
    "completed_at": "2025-11-10T17:00:00Z"
  }
]
```

---

#### 8.5.2 Создание подзадачи

```http
POST /api/v1/tasks/{task_id}/items/
```

**Request Body:**
```json
{
  "title": "Составление спецификации",
  "description": "Подготовить спецификацию оборудования",
  "executor": 3,
  "planned_hours": 16
}
```

**Response (201):** Созданная подзадача

---

#### 8.5.3 Обновление подзадачи

```http
PATCH /api/v1/tasks/{task_id}/items/{item_id}/
```

**Request Body:**
```json
{
  "status": "in_progress"
}
```

**Response (200):** Обновленная подзадача

---

#### 8.5.4 Отметить подзадачу выполненной

```http
POST /api/v1/tasks/{task_id}/items/{item_id}/complete/
```

**Response (200):**
```json
{
  "id": 1,
  "status": "completed",
  "completed_at": "2025-11-15T15:30:00Z"
}
```

---

#### 8.5.5 Изменение порядка подзадач

```http
POST /api/v1/tasks/{task_id}/items/reorder/
```

**Request Body:**
```json
{
  "items": [3, 1, 2, 5, 4]
}
```

**Response (200):**
```json
{
  "message": "Порядок подзадач обновлен"
}
```

---

#### 8.5.6 Удаление подзадачи

```http
DELETE /api/v1/tasks/{task_id}/items/{item_id}/
```

**Response (204):** No Content

---

### 8.6 Роли

#### 8.6.1 Список ролей в задаче

```http
GET /api/v1/tasks/{task_id}/roles/
```

**Response (200):**
```json
[
  {
    "id": 1,
    "user": {
      "id": 2,
      "full_name": "Анна Смирнова"
    },
    "role": "assigner",
    "assigned_at": "2025-11-01T09:00:00Z"
  },
  {
    "id": 2,
    "user": {
      "id": 5,
      "full_name": "Петр Козлов"
    },
    "role": "co_executor",
    "assigned_at": "2025-11-01T09:00:00Z"
  }
]
```

---

#### 8.6.2 Назначение роли

```http
POST /api/v1/tasks/{task_id}/roles/
```

**Request Body:**
```json
{
  "user": 6,
  "role": "observer"
}
```

**Response (201):** Созданная роль

---

#### 8.6.3 Удаление роли

```http
DELETE /api/v1/tasks/{task_id}/roles/{role_id}/
```

**Response (204):** No Content

---

### 8.7 Учет времени

#### 8.7.1 Список записей времени

```http
GET /api/v1/tasks/{task_id}/timelogs/
```

**Query Parameters:**
- `user` - фильтр по пользователю
- `task_item` - фильтр по подзадаче
- `date_from` - с даты
- `date_to` - по дату

**Response (200):**
```json
{
  "count": 15,
  "results": [
    {
      "id": 1,
      "task": 1,
      "task_item": {
        "id": 1,
        "title": "Расчет воздухообмена"
      },
      "user": {
        "id": 3,
        "full_name": "Иван Петров"
      },
      "hours": 8.5,
      "date": "2025-11-15",
      "description": "Выполнен расчет воздухообмена для 1-3 этажей",
      "created_at": "2025-11-15T17:00:00Z"
    }
  ]
}
```

---

#### 8.7.2 Добавление записи времени

```http
POST /api/v1/tasks/{task_id}/timelogs/
```

**Request Body:**
```json
{
  "task_item": 1,
  "hours": 8.5,
  "date": "2025-11-15",
  "description": "Выполнен расчет воздухообмена для 1-3 этажей"
}
```

**Response (201):** Созданная запись

---

#### 8.7.3 Обновление записи времени

```http
PUT /api/v1/tasks/{task_id}/timelogs/{log_id}/
```

**Request Body:**
```json
{
  "hours": 9,
  "description": "Выполнен расчет воздухообмена для 1-3 этажей + корректировки"
}
```

**Response (200):** Обновленная запись

---

#### 8.7.4 Удаление записи времени

```http
DELETE /api/v1/tasks/{task_id}/timelogs/{log_id}/
```

**Response (204):** No Content

---

### 8.8 Комментарии

#### 8.8.1 Список комментариев

```http
GET /api/v1/tasks/{task_id}/comments/
```

**Query Parameters:**
- `task_item` - фильтр по подзадаче

**Response (200):**
```json
[
  {
    "id": 1,
    "task": 1,
    "task_item": null,
    "author": {
      "id": 2,
      "full_name": "Анна Смирнова"
    },
    "text": "Необходимо учесть требования заказчика по уровню шума",
    "created_at": "2025-11-05T10:30:00Z",
    "updated_at": "2025-11-05T10:30:00Z"
  }
]
```

---

#### 8.8.2 Добавление комментария

```http
POST /api/v1/tasks/{task_id}/comments/
```

**Request Body:**
```json
{
  "task_item": 1,
  "text": "Расчет выполнен, переходим к следующему этапу"
}
```

**Response (201):** Созданный комментарий

---

#### 8.8.3 Обновление комментария

```http
PUT /api/v1/tasks/{task_id}/comments/{comment_id}/
```

**Request Body:**
```json
{
  "text": "Расчет выполнен и согласован, переходим к следующему этапу"
}
```

**Response (200):** Обновленный комментарий

---

#### 8.8.4 Удаление комментария

```http
DELETE /api/v1/tasks/{task_id}/comments/{comment_id}/
```

**Response (204):** No Content

---

### 8.9 Статистика

#### 8.9.1 Статистика по задаче

```http
GET /api/v1/tasks/{task_id}/stats/
```

**Response (200):**
```json
{
  "task_id": 1,
  "progress": {
    "percentage": 45.5,
    "completed_items": 3,
    "total_items": 8
  },
  "hours": {
    "planned": 120,
    "spent": 54.5,
    "remaining": 65.5,
    "deviation": -7.5,
    "deviation_percentage": -13.8
  },
  "dates": {
    "planned_start": "2025-11-01",
    "actual_start": "2025-11-01",
    "planned_end": "2025-11-30",
    "actual_end": null,
    "days_remaining": 15,
    "is_overdue": false
  },
  "items_by_status": {
    "todo": 2,
    "in_progress": 3,
    "completed": 3,
    "blocked": 0
  },
  "executors": [
    {
      "user": {
        "id": 3,
        "full_name": "Иван Петров"
      },
      "items_count": 3,
      "completed_items": 2,
      "planned_hours": 40,
      "spent_hours": 35
    }
  ]
}
```

---

### 8.10 Персональные эндпоинты

#### 8.10.1 Мои задачи

```http
GET /api/v1/tasks/my/
```

Возвращает задачи, где текущий пользователь является:
- Постановщиком
- Соисполнителем
- Наблюдателем
- Исполнителем хотя бы одной подзадачи

**Response (200):** Список задач (аналогично GET /tasks/)

---

#### 8.10.2 Мои подзадачи

```http
GET /api/v1/tasks/my/items/
```

**Query Parameters:**
- `status` - фильтр по статусу

**Response (200):**
```json
{
  "count": 5,
  "results": [
    {
      "id": 1,
      "task": {
        "id": 1,
        "title": "Разработка системы вентиляции"
      },
      "title": "Расчет воздухообмена",
      "status": "completed",
      "planned_hours": 24,
      "spent_hours": 26.5,
      "completed_at": "2025-11-10T17:00:00Z"
    }
  ]
}
```

---

#### 8.10.3 Назначенные мной задачи

```http
GET /api/v1/tasks/my/assigned/
```

Возвращает задачи, где текущий пользователь является постановщиком.

**Response (200):** Список задач

---

## 9. ПРАВА ДОСТУПА И РОЛИ

### 9.1 Матрица прав доступа

| Операция | Постановщик | Соисполнитель | Исполнитель TaskItem | Наблюдатель | Другие |
|----------|-------------|---------------|----------------------|-------------|--------|
| **Task** |
| Просмотр задачи | ✅ | ✅ | ✅ | ✅ | ❌ |
| Редактирование задачи | ✅ | ❌ | ❌ | ❌ | ❌ |
| Удаление задачи | ✅ | ❌ | ❌ | ❌ | ❌ |
| Изменение статуса задачи | ✅ | ❌ | ❌ | ❌ | ❌ |
| **TaskItem** |
| Создание подзадачи | ✅ | ❌ | ❌ | ❌ | ❌ |
| Редактирование подзадачи | ✅ | ❌ | ✅ (свою) | ❌ | ❌ |
| Удаление подзадачи | ✅ | ❌ | ❌ | ❌ | ❌ |
| Изменение статуса подзадачи | ✅ | ❌ | ✅ (свою) | ❌ | ❌ |
| Изменение исполнителя | ✅ | ❌ | ❌ | ❌ | ❌ |
| **TaskRole** |
| Назначение ролей | ✅ | ❌ | ❌ | ❌ | ❌ |
| Удаление ролей | ✅ | ❌ | ❌ | ❌ | ❌ |
| **TimeLog** |
| Добавление времени | ✅ | ✅ | ✅ | ❌ | ❌ |
| Редактирование времени | ✅ | ✅ (свое) | ✅ (свое) | ❌ | ❌ |
| Удаление времени | ✅ | ✅ (свое) | ✅ (свое) | ❌ | ❌ |
| **Comment** |
| Добавление комментария | ✅ | ✅ | ✅ | ✅ | ❌ |
| Редактирование комментария | ✅ | ✅ (свой) | ✅ (свой) | ✅ (свой) | ❌ |
| Удаление комментария | ✅ | ✅ (свой) | ✅ (свой) | ✅ (свой) | ❌ |

---

### 9.2 Реализация Permissions в DRF

#### 9.2.1 IsTaskParticipant

```python
class IsTaskParticipant(permissions.BasePermission):
    """
    Доступ только участникам задачи.
    """
    def has_object_permission(self, request, view, obj):
        task = obj if isinstance(obj, Task) else obj.task
        user = request.user
        
        # Проверяем роли в задаче
        if task.roles.filter(user=user).exists():
            return True
        
        # Проверяем, является ли исполнителем хотя бы одной подзадачи
        if task.task_items.filter(executor=user).exists():
            return True
        
        return False
```

#### 9.2.2 IsAssignerOrReadOnly

```python
class IsAssignerOrReadOnly(permissions.BasePermission):
    """
    Только постановщик может редактировать.
    Остальные участники - только чтение.
    """
    def has_object_permission(self, request, view, obj):
        if request.method in permissions.SAFE_METHODS:
            return True
        
        task = obj if isinstance(obj, Task) else obj.task
        return task.roles.filter(user=request.user, role='assigner').exists()
```

#### 9.2.3 IsTaskItemExecutorOrAssigner

```python
class IsTaskItemExecutorOrAssigner(permissions.BasePermission):
    """
    TaskItem может редактировать исполнитель или постановщик.
    """
    def has_object_permission(self, request, view, obj):
        if request.method in permissions.SAFE_METHODS:
            return True
        
        user = request.user
        
        # Исполнитель TaskItem
        if obj.executor == user:
            return True
        
        # Постановщик основной задачи
        if obj.task.roles.filter(user=user, role='assigner').exists():
            return True
        
        return False
```

---

## 10. ТРЕБОВАНИЯ К БЕЗОПАСНОСТИ

### 10.1 Аутентификация и авторизация

#### 10.1.1 Хранение паролей
- Использование Argon2 или bcrypt для хеширования
- Минимальная длина пароля: 8 символов
- Требования к паролю: буквы, цифры, спецсимволы

#### 10.1.2 JWT токены
- Access token: срок жизни 15 минут
- Refresh token: срок жизни 7 дней
- Использование RS256 алгоритма
- Хранение refresh токенов в whitelist (Redis)

#### 10.1.3 Сессии
- Автоматический logout при неактивности > 2 часа
- Возможность принудительного logout со всех устройств

---

### 10.2 Защита API

#### 10.2.1 Rate Limiting
```
Аутентификация:
- 5 попыток входа в минуту на IP
- 20 попыток входа в час на email

Обычные запросы:
- 100 запросов в минуту на пользователя
- 1000 запросов в час на пользователя
```

#### 10.2.2 CORS
```python
CORS_ALLOWED_ORIGINS = [
    "https://tasktracker.com",
    "https://app.tasktracker.com",
]

CORS_ALLOW_CREDENTIALS = True
```

#### 10.2.3 HTTPS
- Обязательное использование HTTPS для всех запросов
- HSTS заголовки
- Secure cookies

---

### 10.3 Валидация данных

#### 10.3.1 Входные данные
- Валидация всех полей на уровне сериализаторов
- Ограничение размера запросов: 10 MB
- Санитизация HTML в текстовых полях

#### 10.3.2 SQL Injection
- Использование ORM Django (защита по умолчанию)
- Запрет raw SQL запросов без параметризации

#### 10.3.3 XSS
- Автоматическое экранирование в шаблонах (если используются)
- Content-Security-Policy заголовки

---

### 10.4 Логирование безопасности

**События для логирования:**
- Успешные/неуспешные попытки входа
- Создание/удаление пользователей
- Изменение критичных настроек
- Доступ к чужим данным (попытки)
- API ошибки 4xx, 5xx

**Формат лога:**
```json
{
  "timestamp": "2025-11-15T10:30:00Z",
  "event_type": "login_failed",
  "user_email": "user@example.com",
  "ip_address": "192.168.1.100",
  "user_agent": "Mozilla/5.0...",
  "details": "Invalid password"
}
```

---

### 10.5 Защита данных

#### 10.5.1 Резервное копирование
- Автоматический backup БД: каждые 24 часа
- Хранение backup: 30 дней
- Тестирование восстановления: раз в месяц

#### 10.5.2 Шифрование
- Шифрование данных при передаче (TLS 1.3)
- Шифрование чувствительных данных в БД (если требуется)

---

## 11. ТРЕБОВАНИЯ К ТЕСТИРОВАНИЮ

### 11.1 Покрытие тестами

**Целевое покрытие:** минимум 75%

**Обязательное покрытие:**
- Models: 100%
- Serializers: 90%
- Views: 80%
- Permissions: 100%
- Services/Utils: 80%

---

### 11.2 Типы тестов

#### 11.2.1 Unit тесты
- Тестирование моделей (валидация, методы, свойства)
- Тестирование сериализаторов (валидация, create, update)
- Тестирование permissions
- Тестирование утилит и сервисов

#### 11.2.2 Integration тесты
- Тестирование API endpoints
- Тестирование бизнес-логики с несколькими моделями
- Тестирование сигналов

#### 11.2.3 E2E тесты
- Полные сценарии использования:
  - Создание задачи → Добавление подзадач → Выполнение → Закрытие
  - Учет времени → Расчет статистики
  - Управление ролями → Проверка доступа

---

### 11.3 Тестовые данные

#### 11.3.1 Fixtures
```python
# apps/tasks/tests/fixtures.py

@pytest.fixture
def user():
    return User.objects.create_user(
        email='test@example.com',
        password='TestPass123!',
        first_name='Test',
        last_name='User'
    )

@pytest.fixture
def task(user):
    return Task.objects.create(
        title='Test Task',
        description='Test Description',
        planned_start_date='2025-11-01',
        planned_end_date='2025-11-30'
    )
```

#### 11.3.2 Фабрики (Factory Boy)
```python
class UserFactory(factory.django.DjangoModelFactory):
    class Meta:
        model = User
    
    email = factory.Faker('email')
    first_name = factory.Faker('first_name')
    last_name = factory.Faker('last_name')
    position = 'Инженер'

class TaskFactory(factory.django.DjangoModelFactory):
    class Meta:
        model = Task
    
    title = factory.Faker('sentence')
    description = factory.Faker('text')
    status = 'new'
```

---

### 11.4 Примеры тестов

#### 11.4.1 Тест модели

```python
# apps/tasks/tests/test_models.py

def test_task_progress_calculation():
    task = TaskFactory()
    TaskItemFactory.create_batch(5, task=task, status='todo')
    TaskItemFactory.create_batch(3, task=task, status='completed')
    
    assert task.progress_percentage == 37.5  # 3/8 * 100

def test_task_spent_hours():
    task = TaskFactory()
    item = TaskItemFactory(task=task)
    
    TimeLogFactory(task=task, task_item=item, hours=5)
    TimeLogFactory(task=task, task_item=item, hours=3.5)
    
    assert task.total_spent_hours == 8.5
```

#### 11.4.2 Тест API

```python
# apps/tasks/tests/test_views.py

@pytest.mark.django_db
class TestTaskViewSet:
    
    def test_create_task(self, api_client, user):
        api_client.force_authenticate(user=user)
        
        data = {
            'title': 'New Task',
            'description': 'Description',
            'task_items': [
                {'title': 'Item 1', 'executor': user.id}
            ]
        }
        
        response = api_client.post('/api/v1/tasks/', data, format='json')
        
        assert response.status_code == 201
        assert Task.objects.count() == 1
        assert TaskItem.objects.count() == 1
    
    def test_unauthorized_access(self, api_client):
        response = api_client.get('/api/v1/tasks/')
        assert response.status_code == 401
```

#### 11.4.3 Тест permissions

```python
# apps/tasks/tests/test_permissions.py

def test_only_assigner_can_edit_task(api_client):
    assigner = UserFactory()
    other_user = UserFactory()
    task = TaskFactory()
    TaskRoleFactory(task=task, user=assigner, role='assigner')
    
    # Постановщик может редактировать
    api_client.force_authenticate(user=assigner)
    response = api_client.patch(f'/api/v1/tasks/{task.id}/', {'title': 'New'})
    assert response.status_code == 200
    
    # Другой пользователь не может
    api_client.force_authenticate(user=other_user)
    response = api_client.patch(f'/api/v1/tasks/{task.id}/', {'title': 'New'})
    assert response.status_code == 403
```

---

### 11.5 CI/CD тестирование

#### 11.5.1 GitHub Actions
```yaml
# .github/workflows/tests.yml

name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -r requirements/testing.txt
      
      - name: Run tests
        run: |
          pytest --cov=apps --cov-report=xml
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
```

---

## 12. ТЕХНОЛОГИЧЕСКИЙ СТЕК

### 12.1 Backend

#### 12.1.1 Основные технологии
- **Python:** 3.11+
- **Django:** 4.2 LTS
- **Django REST Framework:** 3.14+
- **PostgreSQL:** 15+

#### 12.1.2 Дополнительные библиотеки

```txt
# requirements/base.txt

# Core
Django==4.2.7
djangorestframework==3.14.0
psycopg2-binary==2.9.9

# Authentication
djangorestframework-simplejwt==5.3.0
dj-rest-auth==5.0.2

# Documentation
drf-spectacular==0.26.5

# Filtering & Search
django-filter==23.4
django-cors-headers==4.3.0

# Environment
python-dotenv==1.0.0
python-decouple==3.8

# Validation
django-phonenumber-field==7.2.0

# Celery (optional)
celery==5.3.4
redis==5.0.1

# File handling
Pillow==10.1.0
```

---

### 12.2 Development

```txt
# requirements/development.txt

-r base.txt

# Testing
pytest==7.4.3
pytest-django==4.7.0
pytest-cov==4.1.0
pytest-mock==3.12.0
factory-boy==3.3.0

# Code quality
black==23.11.0
flake8==6.1.0
isort==5.12.0
mypy==1.7.0
django-stubs==4.2.6

# Debugging
django-debug-toolbar==4.2.0
django-extensions==3.2.3
ipython==8.17.2

# Documentation
sphinx==7.2.6
```

---

### 12.3 Production

```txt
# requirements/production.txt

-r base.txt

# WSGI server
gunicorn==21.2.0

# Monitoring
sentry-sdk==1.38.0

# Performance
django-redis==5.4.0
```

---

### 12.4 DevOps

#### 12.4.1 Docker

```dockerfile
# Dockerfile

FROM python:3.11-slim

ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    postgresql-client \
    && rm -rf /var/lib/apt/lists/*

# Install Python dependencies
COPY requirements/production.txt .
RUN pip install --no-cache-dir -r production.txt

# Copy project
COPY . .

# Create non-root user
RUN useradd -m -u 1000 appuser && chown -R appuser:appuser /app
USER appuser

EXPOSE 8000

CMD ["gunicorn", "config.wsgi:application", "--bind", "0.0.0.0:8000"]
```

#### 12.4.2 Docker Compose

```yaml
# docker-compose.yml

version: '3.9'

services:
  db:
    image: postgres:15
    environment:
      POSTGRES_DB: tasktracker
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
  
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
  
  web:
    build: .
    command: gunicorn config.wsgi:application --bind 0.0.0.0:8000
    volumes:
      - ./:/app
      - static_volume:/app/staticfiles
      - media_volume:/app/media
    ports:
      - "8000:8000"
    env_file:
      - .env
    depends_on:
      - db
      - redis
  
  celery:
    build: .
    command: celery -A config worker -l info
    volumes:
      - ./:/app
    env_file:
      - .env
    depends_on:
      - db
      - redis

volumes:
  postgres_data:
  static_volume:
  media_volume:
```

---

## 13. ЭТАПЫ РАЗРАБОТКИ

### 13.1 Этап 1: Настройка проекта (1 неделя)

**Задачи:**
- Создание структуры Django проекта
- Настройка окружений (dev, test, prod)
- Настройка базы данных PostgreSQL
- Настройка Docker и Docker Compose
- Создание базовой модели User
- Настройка JWT аутентификации
- Настройка CI/CD (GitHub Actions)

**Критерии приемки:**
- ✅ Проект запускается в Docker
- ✅ Работает аутентификация (register, login, refresh)
- ✅ Настроены окружения
- ✅ CI/CD выполняет тесты

---

### 13.2 Этап 2: Модели и миграции (1 неделя)

**Задачи:**
- Создание моделей: Task, TaskRole, TaskItem
- Создание моделей: TimeLog, TaskComment
- Написание миграций
- Создание admin-панели для всех моделей
- Написание unit-тестов для моделей

**Критерии приемки:**
- ✅ Все модели созданы и протестированы
- ✅ Миграции применяются без ошибок
- ✅ Admin-панель работает
- ✅ Unit-тесты покрывают модели на 100%

---

### 13.3 Этап 3: API задач (2 недели)

**Задачи:**
- Создание сериализаторов для Task, TaskItem, TaskRole
- Реализация ViewSets для задач
- Реализация permissions
- Реализация фильтрации и поиска
- Написание API тестов
- Документация Swagger

**Эндпоинты:**
- CRUD операции для Task
- CRUD операции для TaskItem
- Управление ролями (TaskRole)
- Фильтрация и поиск
- Персональные представления

**Критерии приемки:**
- ✅ Все эндпоинты работают
- ✅ Права доступа проверены
- ✅ API тесты покрывают 80%+
- ✅ Swagger документация актуальна

---

### 13.4 Этап 4: Учет времени и комментарии (1 неделя)

**Задачи:**
- API для TimeLog (CRUD)
- API для TaskComment (CRUD)
- Валидация данных
- Расчет статистики
- Тестирование

**Эндпоинты:**
- CRUD для TimeLog
- CRUD для TaskComment
- Агрегированная статистика по времени

**Критерии приемки:**
- ✅ Учет времени работает корректно
- ✅ Комментарии создаются и отображаются
- ✅ Статистика рассчитывается правильно
- ✅ Тесты покрывают функционал

---

### 13.5 Этап 5: Статистика и отчеты (1 неделя)

**Задачи:**
- Эндпоинт статистики по задаче
- Личная статистика пользователя
- Оптимизация запросов (select_related, prefetch_related)
- Кэширование (Redis)

**Критерии приемки:**
- ✅ Статистика отображается корректно
- ✅ Производительность соответствует требованиям
- ✅ Кэширование работает

---

### 13.6 Этап 6: Тестирование и документация (1 неделя)

**Задачи:**
- Достижение покрытия тестами 75%+
- Полная документация API
- Написание README.md
- Создание seed-скриптов для демо-данных
- Нагрузочное тестирование

**Критерии приемки:**
- ✅ Покрытие тестами >= 75%
- ✅ Документация завершена
- ✅ README содержит инструкции по развертыванию
- ✅ Демо-данные создаются скриптом

---

### 13.7 Этап 7: Деплой и финализация (1 неделя)

**Задачи:**
- Настройка production окружения
- Настройка SSL сертификатов
- Настройка логирования и мониторинга
- Настройка backup
- Финальное тестирование

**Критерии приемки:**
- ✅ Приложение развернуто на production
- ✅ HTTPS работает
- ✅ Логи пишутся корректно
- ✅ Backup настроен и протестирован

---

## 14. КРИТЕРИИ ПРИЕМКИ

### 14.1 Функциональные критерии

#### 14.1.1 Задачи
- ✅ Пользователь может создать задачу с подзадачами
- ✅ Постановщик может редактировать задачу
- ✅ Постановщик может удалить задачу
- ✅ Участники видят только свои задачи
- ✅ Прогресс задачи рассчитывается автоматически

#### 14.1.2 Подзадачи
- ✅ Постановщик может добавить подзадачу
- ✅ Исполнитель может изменить статус своей подзадачи
- ✅ Постановщик может переназначить исполнителя
- ✅ Подзадачи можно сортировать

#### 14.1.3 Роли
- ✅ Постановщик может назначать роли
- ✅ Роли корректно ограничивают доступ
- ✅ Один пользователь = одна роль в задаче

#### 14.1.4 Учет времени
- ✅ Участники могут логировать время
- ✅ Время суммируется корректно
- ✅ Статистика по времени отображается правильно

#### 14.1.5 Комментарии
- ✅ Участники могут комментировать
- ✅ Автор может редактировать свой комментарий
- ✅ Комментарии отображаются в хронологическом порядке

---

### 14.2 Нефункциональные критерии

#### 14.2.1 Производительность
- ✅ Время отклика API < 500 мс (95-й перцентиль)
- ✅ Поддержка 1000 одновременных пользователей
- ✅ База данных оптимизирована (индексы, запросы)

#### 14.2.2 Безопасность
- ✅ Все запросы через HTTPS
- ✅ JWT аутентификация работает
- ✅ Rate limiting настроен
- ✅ Валидация всех входных данных

#### 14.2.3 Тестирование
- ✅ Покрытие тестами >= 75%
- ✅ Все критичные функции покрыты тестами
- ✅ CI/CD выполняет тесты автоматически

#### 14.2.4 Документация
- ✅ Swagger документация актуальна
- ✅ README содержит инструкции
- ✅ Код прокомментирован (сложные части)
- ✅ ER-диаграмма базы данных создана

#### 14.2.5 Код
- ✅ Соблюдение PEP 8
- ✅ Код отформатирован через Black
- ✅ Нет критичных замечаний от flake8
- ✅ Type hints используются

---

### 14.3 Приемочное тестирование

#### Сценарий 1: Полный цикл работы с задачей

1. Регистрация пользователей (постановщик, 2 исполнителя)
2. Вход постановщика
3. Создание задачи с 3 подзадачами
4. Назначение исполнителей на подзадачи
5. Добавление соисполнителя
6. Вход исполнителя 1
7. Изменение статуса своей подзадачи на "in_progress"
8. Логирование времени (8 часов)
9. Завершение подзадачи
10. Добавление комментария
11. Вход постановщика
12. Проверка прогресса задачи
13. Просмотр статистики

**Ожидаемый результат:**
- Все операции выполняются успешно
- Права доступа работают корректно
- Статистика отображается правильно

---

## ПРИЛОЖЕНИЯ

### Приложение А: Глоссарий

**API** - Application Programming Interface  
**CRUD** - Create, Read, Update, Delete  
**DRF** - Django REST Framework  
**JWT** - JSON Web Token  
**ORM** - Object-Relational Mapping  
**REST** - Representational State Transfer  

### Приложение Б: Контакты

**Разработка:**  
Email: dev@tasktracker.com

**Техническая поддержка:**  
Email: support@tasktracker.com

---

**КОНЕЦ ДОКУМЕНТА**
